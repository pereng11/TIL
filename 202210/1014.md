# 22/10/14

## 오늘 삽질한 것

### 또 웹팩..

#### 동작 원리를 알고 쓰자

- 딜레마에 빠졌다. 서버를 로컬 서버 하나만 사용하려고 하니 hot reload가 불가능해서 파일을 수정할 때마다 직접 새로고침을 해야했고, webpack-dev-server를 사용하니 로컬 서버가 파일 변경을 실시간으로 감지하지 못했다.
- webpack-dev-server도 파일 변경을 감지한다고 하길래, 파일이 변경되면 자동으로 빌드하고, 빌드가 완료되면 브라우저를 새로고침한다고 생각했다.
- 하지만 webpack-dev-server는 직접 빌드 파일을 생성하거나 수정하지 않고, 소스파일의 변경만을 감지하여 실시간으로 적용해주는 것이었다...
- 따라서, webpack-dev-server + nodemon 조합으로는 로컬 서버의 페이지를 백날 새로고침해봐야 업데이트가 적용이 될 수가 없었다. 로컬서버는 빌드 파일을 불러오는데, 그 파일은 변하지 않으니까....
- 빌드된 파일이 없으면 webpack-dev-server를 실행할 수 없다는 부분에서 알아차려야 했다....

#### 꼼수쓰지 말고 정면돌파하자

- 어제도 원래 계획은 로컬 서버에 빌드된 파일이 실시간으로 적용되도록 하는 것이었다. 하지만 밤새 해결을 못하고, 구글링한 글들에서 다들 webpack-dev-server를 쓰라고 하길래 에라 모르겠다하고 기존 계획을 포기했다.
- 하지만 웬걸, 오늘 라우팅 처리를 하다가 깨달았다. 새로고침, 주소창 입력 등으로 페이지에 처음 접속하는 경우를 로컬 서버가 처리해야 하는데, webpack-dev-server쪽에서는 해당 작업을 처리하는 것이 근본적으로 불가능했다.
- 결국 정상적으로 개발을 하려면 원래 계획대로 소스파일을 빌드하면 서버가 빌드된 최신 파일을 가져오도록 해야했다. 매번 수동으로 빌드하고 서버를 재구동하던, 더 좋은 방법을 찾아내던...
- 해결 방법을 찾아내기는 했는데..썩 마음에 들지는 않는다. 기존에 사용하던 npm-run-all을 사용해 세 명령을 한 번에 수행하도록 하면 일단 원하던대로 동작한다

```javascript
  "scripts": {
    "start": "run-p webpack-dev-server webpack-watch server",
    "server": "nodemon -e js,css,html --watch dist/ --watch server.js server.js",
    "webpack-dev-server": "webpack serve",
    "webpack-watch": "webpack -w",
    "build": "rm -rf dist && webpack"
  },
```

각 명령이 수행하는 동작은 다음과 같다
- `npm start`
	-   자동 빌드 명령 , hot-reload를 위한 명령, 파일 변경에 따른 서버 재구동 명령을 동시에 실행한다
- `npm run server`
	- 지정한 경로(dist 폴더, server.js 파일)의 지정한 확장자(js, css, html)의 파일이 변경되면 서버를 재구동한다
- `npm run webpack-dev-server`
	- 소스 파일의 변경을 감지해서 webpack-dev-server가 제공하는 서버를 재구동하고 페이지를 자동 새로고침 해준다
- `npm run webpack-watch`
	- 소스파일의 변경을 감지해서 자동으로 빌드한다
- `npm run build`
	- 기존에 있던 배포 폴더를 삭제하고 새로 빌드한다

#### 아쉬운 점

- 어차피 변경 감지할 거, 서버가 재구동될 때 브라우저를 새로고침하게 만들면 webpack-dev-server가 굳이 필요한가 싶다. 일단 다른 라이브러리를 추가로 설치하면 가능하다고 하는데, 라이브러리가 점점 많아지는 것도 배보다 배꼽이 커지는 느낌이라 찜찜하다. 일단 해야하는 일 먼저 하고 내일 맑은 정신으로 다시 고민해봐야겠다.

